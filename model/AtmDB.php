<?php/** * Created by PhpStorm. * User: tuan * Date: 26/09/2018 * Time: 08:41 */namespace mondel;class AtmDB{    public $conn;    public function __construct($conn)    {        $this->conn = $conn;    }    public function getAll()    {        $sql = "SELECT * FROM transaction_history";        $query = $this->conn->query($sql);        $result = $query->fetchAll();        $posts = [];        foreach ($result as $row) {            $post = new Atm($row['id'], $row['target_id'], $row['source_id'], $row['amount'], $row['content'], $row['datetime'], $row['success']);            $posts[] = $post;        }        return $posts;    }    public function getAllUser()    {        $sql = "SELECT * FROM user_account";        $query = $this->conn->query($sql);        $result = $query->fetchAll();        $posts = [];        foreach ($result as $row) {            $post = new User($row['id'], $row['username'], $row['balance']);            $posts[] = $post;        }        return $posts;    }    public function create($user1, $amount, $user2, $date, $content)    {        $this->conn->beginTransaction();        $sql = "SELECT `balance` FROM user_account WHERE id = ?";        $query = $this->conn->prepare($sql);        $query->execute([$user1]);        $availableAmount = (int)$query->fetchColumn();        $result = $query->fetchAll();        if ($availableAmount < $amount) {            echo "số tiền của bạn không đủ ";            $success = 0;        };        if ($availableAmount > $amount) {            $sqlUpdateUser1 = "UPDATE `user_account` SET balance=balance - ? WHERE id = ?";            $query = $this->conn->prepare($sqlUpdateUser1);            $query->execute([$amount, $user1]);            $sqlUpdateUser2 = "UPDATE `user_account` SET balance=balance + ? WHERE id = ?";            $query = $this->conn->prepare($sqlUpdateUser2);            $query->execute([$amount, $user2]);            $success = 1;        }else {            $success = 0;        };        $update = "INSERT INTO `transaction_history`(`target_id`, `source_id`, `amount`, `content`, `datetime`, `success`) VALUES (?,?,?,?,?)";        $query = $this->conn->prepare($update);        $query->execute([$user1, $user2, $amount, "$content", "$date", $success]);        $this->conn->commit();    }}